% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/bulkdecon.R
\name{bulkdecon}
\alias{bulkdecon}
\title{Mixed Cell Deconvolution of Bulk Gene Expression Data}
\usage{
bulkdecon(
  norm,
  bg,
  X = NULL,
  raw = NULL,
  wts = NULL,
  resid_thresh = 3,
  lower_thresh = 0.5,
  align_genes = TRUE,
  is_pure_tumor = NULL,
  n_tumor_clusters = 10,
  cell_counts = NULL,
  cellmerges = NULL,
  maxit = 1000
)
}
\arguments{
\item{norm}{A p-length expression vector or a p × N matrix of log-expression.}

\item{bg}{Background expectation (same dimension as \code{norm}).}

\item{X}{Cell profile matrix. If \code{NULL}, the bundled \code{safeTME} reference
from \strong{BulkDecon} is used.}

\item{raw}{Optional raw (linear-scale) expression matrix for deriving weights.}

\item{wts}{Optional weights matrix for genes × samples.}

\item{resid_thresh}{Threshold (log2 units) for outlier residual removal.}

\item{lower_thresh}{Threshold for residual stabilization.}

\item{align_genes}{Logical; if \code{TRUE}, aligns the gene sets between \code{norm} and \code{X}.}

\item{is_pure_tumor}{Optional logical vector indicating pure tumor samples.}

\item{n_tumor_clusters}{Number of tumor clusters to merge into the reference.}

\item{cell_counts}{Optional numeric vector of nuclei counts per sample.}

\item{cellmerges}{Optional list mapping granular → merged cell types.}

\item{maxit}{Maximum number of iterations for the optimization procedure.}
}
\value{
A list containing:
\itemize{
\item \code{beta} – estimated cell-type abundance matrix
\item \code{sigma} – variance estimates
\item \code{p}, \code{t}, \code{se} – p-values, t-statistics, and standard errors
\item \code{prop_of_all}, \code{prop_of_nontumor} – proportional abundances
\item \code{cell.counts} – estimated cell counts (if \code{cell_counts} supplied)
\item \code{X} – processed/merged reference matrix
\item \code{beta.granular}, \code{sigma.granular} – pre-merge estimates (if applicable)
\item all intermediate fields returned by the core deconvolution algorithm
}
}
\description{
Performs bulk deconvolution using the BulkDecon framework, with optional
weighting, tumor merging, cell-type collapsing, and p-value computation.
This function is adapted from the SpatialDecon implementation but uses the
BulkDecon package structure and bundled reference matrix (safeTME).
}
\details{
The function accepts either a vector (single sample) or a matrix of bulk
expression data and estimates the cellular composition using a reference
profile matrix. Additional steps include:
\itemize{
\item optional gene weighting via residual stabilization
\item merging pure-tumor samples into the reference
\item collapsing granular cell types into user-defined merged classes
\item computing t-statistics, standard errors, and p-values
\item proportion scaling and optional conversion to estimated cell counts
}
}
